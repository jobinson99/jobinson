<!DOCTYPE html>
<html>

    <head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>如何在jekyll中随心所欲使用插件</title>
<meta name="description" content="黑传说的学习笔记">

<link rel="canonical" href="http://jobinson.ga/%E5%BB%BA%E7%AB%99%E4%B9%8B%E8%B7%AF/2014/04/27/%E5%A6%82%E4%BD%95%E5%9C%A8jekyll%E4%B8%AD%E9%9A%8F%E5%BF%83%E6%89%80%E6%AC%B2%E4%BD%BF%E7%94%A8%E6%8F%92%E4%BB%B6/">

<!-- 皮肤样式 -->
<link rel="stylesheet" href="/themes/atlas/css/style.css">

<!-- 首页和404各站特异的样式 -->
<link rel="stylesheet" href="/static/main.css">

<link rel="icon" type="image/x-icon" href="/favicon.ico">

</head>
    
  <body>

      <div class="left-top-hook"></div><!-- 站内信息 -->
<div class="right-top-hook"></div><!-- 页内信息 -->
<div class="left-middle-hook"></div><!-- 页内操作 -->
<div class="right-middle-hook"></div><!-- 页内导航 -->
<div class="right-bottom-hook"></div><!-- 站内系统 -->
<div class="left-bottom-hook"></div><!-- 站内栏目 -->

<header class="site-header">  
  <nav class="site-nav">
    <ul>
      <li><a href="/">外立面面</a></li>
      <li><a href="/分类列表/">按分类查看</a></li>
      <li><a href="/话题列表/">按话题查看</a></li>
      <li><a href="/时间列表/">按时间查看</a></li>
      <li><a href="/友情链接/">好友关系</a></li>
      <li><a href="/关于我/">关于我</a></li>
    </ul>
  </nav>
  
</header>  

<nav class="outline toc">
</nav> 

      
      <div class="post">
  
  <header class="post-header">
    <h1 id="如何在jekyll中随心所欲使用插件">如何在jekyll中随心所欲使用插件</h1>

    <div class="post-abstract">
      
      <p><b>摘要：</b><br/>如何在jekyll中使用插件，并且网站上的效果和本地一样：双枝法</p>
      

      
      <p class="post-tag"><b>话题：</b>
        
        <a href="/话题列表/#github-ref">github
        <sup>4</sup></a>
        &nbsp;
        
        <a href="/话题列表/#jekyll-ref">jekyll
        <sup>2</sup></a>
        &nbsp;
        
        <a href="/话题列表/#双库法-ref">双库法
        <sup>1</sup></a>
        &nbsp;
        
        <a href="/话题列表/#子模块-ref">子模块
        <sup>1</sup></a>
        &nbsp;
        
        <a href="/话题列表/#软链-ref">软链
        <sup>1</sup></a>
        &nbsp;
        
      </p>
      
      
    </div>

    <p class="meta">
      
      <span class="post-categories">类别：
        
        <a href="/分类列表/#建站之路-ref">建站之路</a>
        
      </span>
      
      
      创建时间：2014-04-27
      
      
    </p>
    
  </header>

  <article class="post-content">
    <h2 id="github-pages">使用github pages不支持的插件</h2>

<h3 id="pandoc">问题：换用pandoc来渲染？</h3>

<p>由于markdown+liquid会产生种种问题，因此，换用一种比较完美的转码方案。
不知道pandoc对自身语法的支持情况如何？</p>

<p>由于 Github Pages 并不支持 Pandoc，所以就需要在本地将站点完全生成好后再将它送到github上的<em>gh-pages</em>仓库里。</p>

<p>为何需要本地生成好网站？</p>

<ul>
  <li>[Github Page] 不支持插件</li>
  <li>[Github Page] 服务器上软件基于安全角度考虑，会限制较多</li>
  <li>利用 [Github Page] 编译并发布网站相对比较耗时。
很显然，既然已经在本地生成好了网站，再将代码上传到服务器重新编译一遍是挺多余的。</li>
</ul>

<p>虽然麻烦，但也带来几个优点：</p>

<ol>
  <li>本地生成，可以随心所欲地使用各种插件，或者换用别的静态站点生成器……</li>
  <li>这样提交的是已经生成的成品，不用调用Github Pages生成，节省地球资源，也可以提高更新速度，不会出现今晚提交，明早才被更新好的情况。</li>
  <li>麻烦的话，可以把操作过程封装为一条命令搞定，也就不麻烦了。</li>
</ol>

<h3 id="section">实现过程</h3>

<ol>
  <li>安装pandoc</li>
  <li>安装定制过的jekyll
定制的jekyll内容：修改 <code>lib/jekyll/converters/markdown.rb</code> 文件，在 <code>setup</code> 和 <code>convert</code> 中按照其它渲染器的格式增加一个 <code>pandoc</code> 判断即可。</li>
  <li>
    <p>安装pandoc的ruby接口：pandoc-ruby</p>
  </li>
  <li>
    <p>修改 Jekyll 配置文件 _config.yml 如下：</p>

    <pre><code> markdown: pandoc
 pandoc:
     extensions: [mathjax, standalone]
</code></pre>
  </li>
</ol>

<p>上面的 extensions 并不唯一，可以将任何 Pandoc 支持的选项加入其中。</p>

<h2 id="section-1">如何维护双库？</h2>

<p>很明显，这样生成后，源码和生成的静态文件就分开了，如何管理呢？双库法！静态站仓库只需要更新 gh-pages分支。</p>

<p>默认的项目仓库情况：</p>

<table>
  <thead>
    <tr>
      <th>本地仓库</th>
      <th>本地地址</th>
      <th>远程对应的仓库</th>
      <th>作用</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>master</td>
      <td>xxx</td>
      <td>site/origin/master</td>
      <td>网站源码，主分支</td>
    </tr>
    <tr>
      <td>gh-pages</td>
      <td>xxx/_site</td>
      <td>site/origin/gh-pages</td>
      <td>分支，gh-pages只追踪和发布此文件夹下文件。</td>
    </tr>
  </tbody>
</table>

<p>双库法后，项目仓库如下：</p>

<table>
  <thead>
    <tr>
      <th>本地仓库</th>
      <th>本地实际地址</th>
      <th>远程对应的仓库</th>
      <th>作用</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>source/master</td>
      <td>xxx</td>
      <td>source/origin/master</td>
      <td>网站源码，主分支</td>
    </tr>
    <tr>
      <td>site/gh-pages</td>
      <td>xxx/_site</td>
      <td>site/origin/gh-pages</td>
      <td>分支，子模块</td>
    </tr>
  </tbody>
</table>

<p>文件结构如下：</p>

<pre><code>~/
  |-- xxx-source/
  |    |-- _includes/
  |    |-- _posts/
  |    |-- index.html
  |    |-- .nojekyll
  |    |-- _config.yml
  |     ....
  |    |-- _site/ &lt;--- 软链或子模块，也就是发布到gh-pages的文件
  |
  |-- xxx-gh-pages/  ---&gt; 软链或子模块到 xxx-source/_site
</code></pre>

<p>从头开始的完整步骤：</p>

<ol>
  <li>远程开双仓库</li>
  <li>本地新建一文件夹 xxx-source，放入源码，然后同步到远程 <em>git@github.com:username/source.git</em></li>
  <li>生成静态站码</li>
  <li>放入源码到</li>
</ol>

<h3 id="section-2">双仓库的准备工作</h3>

<p>第一步，远程开双仓库。假设为如下：</p>

<ul>
  <li>git@github.com:username/source.git 本地的 xxx-source 会发布到此</li>
  <li>git@github.com:username/site.git 本地的 xxx-gh-pages 会发布到此</li>
</ul>

<p>第二步，关闭github服务器的jekyll编译器。</p>

<p>原理：在上传到gh-pages分支上的文件根目录下，创建一个名为 <em>.nojekyll</em> 的文件，即可关闭github的jekyll编译器。</p>

<p>方法：修改 <em>_config.yml</em>，加入如下两行，让其生成的文件中，带 <em>.nojekyll</em>文件：（后面有需要，还可以加入更多的，此处先加这个最基本的）</p>

<pre><code>include:
- .nojekyll
</code></pre>

<h3 id="section-3">一些有关操作</h3>

<p>远程删除或者添加分支</p>

<pre><code># 删除远程分支
git push origin :gh-pages
# 添加远程分支
git push origin gh-pages
</code></pre>

<p>生成孤立分支：先克隆源码站，然后生成孤立分支 gh-pages （带参数 <code>--orphan</code> 没有历史记录，是一个完全独立背景干净的分支），清空里面所有内容</p>

<pre><code>git clone git@github.com:username/site.git
cd repository

git checkout --orphan gh-pages

git rm -rf .
</code></pre>

<p>加入独有内容后，推送到服务器</p>

<pre><code>git push origin gh-pages
</code></pre>

<p>.htacess呢？ 不行！
redirects呢？</p>

<p>同一目录，但互相监控不同的文件夹？同一目录双库？</p>

<p>先本地建完主分支master，然后新建小分支gh-pages</p>

<pre><code>git branch gh-pages
git push -u origin --all
</code></pre>

<p>一起推向服务器端</p>

<p>然后切换到分支gh-pages。把.git文件全部放入_site中，然后转到_site中，提交。 </p>

<pre><code>git branch gh-pages
git push -u origin --all

git remote add origin ssh://git@github.com/username/site.git
git push -u origin master
git checkout gh-pages
git push -u origin gh-pages   
</code></pre>

<p>可选步骤：删掉主分支，以免混淆。</p>

<pre><code>git branch -d master
git branch  
</code></pre>

<h3 id="section-4">软链双库法</h3>

<p>前提：操作系统是linux，因为需要利用到一个linux才有的特性：软链</p>

<p>其中，<em>_site</em> 文件夹是个软链，本地生成的文件实际是放到硬盘另一个地方，生成后再转入此文件夹，把文件上传到github的origin/gh-pages。</p>

<p>下面不用软链时的操作（由于此法通用于windows下，所以此处也提供出来）： /xxx-source 和 /xxx-gh-pages</p>

<pre><code># 新建文件夹 xxx-gh-pages
mkdir xxx-gh-pages
cd xxx-gh-pages
git clone git@github.com:username/site.git
</code></pre>

<p>接下来，再在 xxx-gh-pages下面，添加 <code>.gitignore</code> 文件， 把一些不要监控的文件添加进去。</p>

<p>发布：</p>

<pre><code>cd ~/xxx-source
# 此处是把源码发布到源码仓库
git add .
git commit -am "发表文章"
git push
# 生成
jekyll build
cd ~/xxx-source/_site/
cp _site/* ~/xxx-gh-pages
cd ~/xxx-gh-pages
git add .
git commit "发表文章"
git push
</code></pre>

<p>浓缩为：（此处省去源码也发布部分，多个shell命令可以用 <code>;</code>或者 <code>&amp;&amp;</code> 连接起来）</p>

<pre><code>alias build_blog="cd ~/xxx-source; jekyll;cp -r ~/xxx-source/_site/* ~/xxx-gh-pages;cd ~/xxx-gh-pages;git add .;git commit -am '发表文章';git push"
alias bb="build_blog"
</code></pre>

<p>总要去复制文件，还不够省俭，如果是linux下，则可以更省俭：使用软链！</p>

<p>把xxx-gh-pages软链到~/xxx-source/_site：</p>

<pre><code># 软链到xxx-source/_site
cd ..
cd xxx-source
ln -s ~/xxx-gh-pages _site
</code></pre>

<p>最后批处理之：</p>

<pre><code>alias build_blog="cd ~/xxx-source; jekyll;cd ~/xxx-gh-pages;git add .;git commit -am '发表文章';git push"
alias bb="build_blog"
</code></pre>

<p><a href="http://charliepark.org/jekyll-with-plugins/">参考此文</a> </p>

<h2 id="submodules">子模块双库法：submodules</h2>

<p>全过程：</p>

<p>说明：为减少时间，在完成新建子模块前，尽可能在两个分支里面，保留尽可能最少的文件，以减少新建子模块时间。</p>

<ol>
  <li>
    <p>开两仓库。</p>
  </li>
  <li>
    <p>清空xxx-gh-pages的内容，并且提交到远程。清空并提交的目的是减少克隆时间。</p>
  </li>
  <li>
    <p>切换到 <em>xxx-source</em> 分支，把 <em>xxx-source</em> 分支也同步到github。
接着，把xxx-gh-pages指为子模块，并挂载到 <code>_site</code>目录下。
注意，此处不要有 <code>_site</code> 文件，下面的命令会自动克隆原有 <em>site</em> 到此处。</p>

    <pre><code> $ git checkout master
 $ git push -u origin --all

 $ git submodule add -b master git@github.com:username/site.git _site
</code></pre>
  </li>
</ol>

<p>在 <em>xxx-source</em> 分支，看看情况：</p>

<pre><code>$ git status
要提交的变更：
  （使用 "git reset HEAD &lt;file&gt;..." 撤出暂存区）

        new file:   .gitmodules
        new file:   _site
</code></pre>

<p>接着直接输入下面命令，提交，并同步github上的source仓库：</p>

<pre><code>$ git commit -m "把xxx-gh-pages变成xxx-source的子模块"
$ git push
</code></pre>

<p>初始化子模块，并看看其指向哪？</p>

<pre><code>$ git submodule init
Submodule '_site' (git@github.com:username/site.git) registered for path '_site'
$ git submodule 
4aac2028817a9de3e31f2c1b84f5783b9d837150 _site (heads/master)
</code></pre>

<ol>
  <li>
    <p>把还没被jekyll生成的源文件都搬到source的目录下，并全部纳入追踪名单。</p>

    <p>$ git add .
 $ git commit -m “全部纳入追踪名单”</p>
  </li>
</ol>

<p>修改 <em>_config.yml</em>，让其生成的文件中，带 <em>.nojekyll</em>文件。</p>

<pre><code>include:
- .nojekyll
</code></pre>

<p>用jekyll生成网站，</p>

<pre><code>$ jekyll build
$ git status
</code></pre>

<p>移动到 <em>_site</em> 目录下，此时，会发现，已经不是在source仓库了，而是自动到了site仓库，看下分支情况：</p>

<pre><code>$ cd _site
$ git status
</code></pre>

<p>把 <em>_site</em> 下文件全部纳入管理，提交，同步到github的site仓库</p>

<pre><code>$ git add .
$ git commit -m "首次生成"
$ git push origin master
</code></pre>

<p>移动到source目录，提交更改，同步到于github的source仓库</p>

<pre><code>$ cd ..
$ git commit -a -m "建站完毕"
$ git push origin source
</code></pre>

<p>到此步已经完成，可以上github的网站看看结果。</p>

<p>总结：以后，整个发布流程变成了：</p>

<ul>
  <li>修改文件</li>
  <li>运行 jekyll 生成</li>
  <li>看下生成结果： _site</li>
  <li>add, commit and push changes in _site subdirectory</li>
  <li>add, commit and push changes in the project (including _site subdir)</li>
  <li>
    <p>不断重复这个过程</p>

    <pre><code>  jekyll build &amp;&amp; cd _site &amp;&amp; git add ./ &amp;&amp; git commit -m '发布' &amp;&amp; git push origin master
</code></pre>
  </li>
</ul>

<p>可以写成一个批处理文件</p>

<pre><code>#!/bin/bash
set -e
message=$1

jekyll build
cd _site
git add ./
git commit -m '$message'
git push origin master
</code></pre>

<p><a href="http://blog.blindgaenger.net/generate_github_pages_in_a_submodule.html">参考此文</a>
<a href="http://indelible.io/blog/2013/07/14/jekyll-plugins-and-github-pages.html">再参考此文</a> </p>

<h2 id="section-5">换用自己喜欢的生成工具</h2>

<p>摸清了github的各种道道后，接下来，已经可以任意使用网页生成工具了。
只需要在生成页面的根目录下，放一个 <em>.nojekyll</em> 文件即可。</p>

<h2 id="section-6">简化图片操作</h2>

<p><a href="http://mad4a.me/2012/08/02/emacs-summary-cont/#outline_2">参考</a></p>

<p>图片路径安排：每篇文章一个图片文件夹</p>

<pre><code>| --- _posts
|       | --- 2012-07-31-hello-world-again.md
|       | --- 2012-08-01-emacs-summary.md
|       | --- 2012-08-02-emacs-summary-cont.md
|
| --- assets
|       | --- images
|       |       | --- emacs-summary
|       |       |       | --- emacs-screenshot.png
|       |       |
|       |       | --- emacs-summary-cont
|       |       |       | --- post-meta-screenshot.png
</code></pre>

<p>要达到的目的：仅仅上下方向键选择图片。</p>

<p>需要创建两个文件：</p>

<ul>
  <li>el文件：用于获取图片路径和列出图片</li>
  <li>yasnippet文件：用于调用上面的el文件中的函数，选择图片。</li>
</ul>

<p>其中el文件，姑且命名为 <code>markdown-image-select.el</code> 填入以下内容：</p>

<p>yasnippet文件， 姑且命名为 <code>i</code>，填入内容：（注意不要换行）</p>

<pre><code>![${1:$$(yas-choose-value (mis-yield-choices (buffer-file-name)))}](/static/images/`(mis-get-directory-from-bufname (buffer-file-name))`/$1)$0
</code></pre>

<p>然后，修改下emacs的配置，调用 <code>markdown-image-select</code>。</p>

<p>最后一步，重启emacs</p>


  </article>

  <!-- 文章页面尾部设定 -->
<div class="post-end">

  <!-- 有言评论 -->
  <div id="uyan_frame"></div>
  <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1921243"></script>
  
  <!-- 结束有言评论 -->

  <div class="post-shift">


    <!--上一篇 话题 下一篇-->
    
    <div class="post-pre">
      <a class="pull-right" href="/%E5%BB%BA%E7%AB%99%E4%B9%8B%E8%B7%AF/2014/04/23/%E9%BB%91%E4%BC%A0%E8%AF%B4%E4%B9%8B%E5%88%A9%E7%94%A8github%E5%BB%BA%E7%BD%91%E7%BB%9C%E6%97%A5%E5%BF%97%E7%AB%99%E6%89%8B%E8%AE%B0/">◁前<br>利用github建网络日志站手记——黑传说版◀篇</a>
    </div>
    
    
     <!--回到头部-->
    <div class="back-top"><a href="#如何在jekyll中随心所欲使用插件">△
    <br>回头▲再看</a></div> 
    
    
    <div class="post-next">
    <a href="/%E6%8A%80%E6%9C%AF%E6%99%AE%E5%8F%8A/2014/04/28/%E8%BD%AF%E4%BB%B6%E6%98%AF%E5%95%A5/">后▷<br>篇▶【公开课】软件是啥</a>
    </div>
    
    
  </div>

<!--页面底部自动浮现-->
  <div class="post-reletive">
  <!--相关文章-->

  </div>


</div>


 
</div>




      
      <footer class="site-footer">
  <ul>
    <li>
      <span>©2014版权所有：黑传说</span>
      <span>欢迎转载，请注明出处并保留原文链接</span>
    </li>
    <li>
    <span>黑传说——乌抵天明</span>
    <span>玄鸟负日，光明万丈</span>
    </li>    
    <li>
    <span><a href="mailto:gmail for jobinson99">gmail for jobinson99</a></span>
    <span><a href="/feed.xml">戳此处关注我</a></span>
    <span><a href="https://github.com/jobinson99">我的开发仓库</a></span>
    </li>    
    <li>
    <span>致谢： <br>
      <a href="http://www.github.com">github</a>，
      <a href="http://jekyllrb.com/">jekyll</a>，
      <a href="http://johnmacfarlane.net/pandoc/index.html">pandoc</a>，以及一切对本人有帮助的人！</span>
    <span>
    <!--百度统计-->  
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fcc95332ab242dd5093ad15fa3eecb313' type='text/javascript'%3E%3C/script%3E"));
</script>

</span>
    </li>     
</ul>
</footer>


    
      
    <script data-main="/themes/atlas/javascript/main" src="/themes/atlas/javascript/require.js" defer async="true"></script>
    
  </body>
</html>
